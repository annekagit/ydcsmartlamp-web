<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>YDC Smartlamp - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* [CSS tetap sama seperti sebelumnya] */
  </style>
</head>
<body>
  <header>
    <h1>💡 YDC Smartlamp</h1>
    <span id="clock" style="font-weight:normal; font-size:1.3rem;"></span>
    <div class="right">
      <span id="greeting">Hallo, teman</span>
      <button onclick="logout()" style="background: #e53935;">Logout</button>
    </div>
  </header>

  <main>
    <!-- [Tampilan dan form tetap sama] -->
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/paho-mqtt@1.1.0/paho-mqtt.min.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    let uid = null;
    let selectedDevice = null;
    let client;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      uid = user.uid;
      document.getElementById("greeting").innerText = "Hallo, " + (user.displayName || user.email);
      loadDevices();
    });

    function setupMQTT() {
      const mqttHost = "a559f98d6d7a4f4ebfb441aada2b1175.s1.eu.hivemq.cloud";
      const mqttPort = 8884;
      const mqttPath = "/mqtt";
      const mqttUser = "webclient_user";
      const mqttPass = "Webpassword123";
      const clientID = "web_" + Math.floor(Math.random() * 100000);

      client = new Paho.Client(mqttHost, mqttPort, mqttPath, clientID);

      client.connect({
        useSSL: true,
        userName: mqttUser,
        password: mqttPass,
        onSuccess: () => {
          document.getElementById("mqtt-status").innerText = "✅ MQTT Terhubung";
        },
        onFailure: e => {
          document.getElementById("mqtt-status").innerText = "❌ MQTT Gagal";
        }
      });

      client.onMessageArrived = message => {
        if (!selectedDevice) return;
        const statusTopic = `smartlamp/status/${selectedDevice}`;
        const scheduleTopic = `smartlamp/schedule_status/${selectedDevice}`;

        if (message.destinationName === statusTopic) {
          const statusText = message.payloadString;
          document.getElementById("lamp-status").innerText = statusText;
          updateLampIcon(statusText);
        } else if (message.destinationName === scheduleTopic) {
          const payload = message.payloadString;
          if (payload === "clear_schedule") {
            document.getElementById("current-schedule").innerText = "⏳ Jadwal Aktif: Tidak ada";
          } else {
            const [time, action] = payload.split("=");
            document.getElementById("current-schedule").innerText = `⏳ Jadwal Aktif: ${time} untuk ${action}`;
          }
        }
      };
    }

    function requestScheduleStatus() {
      sendMessage("schedule_status_request", "get");
    }

    function onDeviceChange() {
      selectedDevice = document.getElementById("device-select").value;
      if (!selectedDevice || !client) {
        document.getElementById("control-section").style.display = "none";
        return;
      }
      client.subscribe(`smartlamp/status/${selectedDevice}`);
      client.subscribe(`smartlamp/schedule_status/${selectedDevice}`);
      document.getElementById("control-section").style.display = "block";
      requestLampStatus();
      requestScheduleStatus(); // PENTING!
    }

    function sendMessage(topic, msg) {
      if (!selectedDevice || !client) return;
      const fullTopic = `smartlamp/${topic}/${selectedDevice}`;
      const message = new Paho.Message(msg);
      message.destinationName = fullTopic;
      client.send(message);
    }

    function requestLampStatus() {
      sendMessage("commands", "status_request");
    }

    function waitForPahoAndSetupMQTT() {
      let attempts = 0;
      const interval = setInterval(() => {
        if (typeof Paho !== "undefined") {
          clearInterval(interval);
          setupMQTT();
        } else if (++attempts > 20) {
          clearInterval(interval);
          document.getElementById("mqtt-status").innerText = "❌ MQTT gagal dimuat";
        }
      }, 250);
    }
    window.addEventListener("load", waitForPahoAndSetupMQTT);

    function loadDevices() {
      const ref = firebase.database().ref("devices/" + uid);
      ref.once("value").then(snapshot => {
        const select = document.getElementById("device-select");
        select.innerHTML = '<option value="">-- Pilih --</option>';
        snapshot.forEach(child => {
          const option = document.createElement("option");
          option.value = child.key;
          option.text = child.val().name;
          select.appendChild(option);
        });
      });
    }

    function turnOn() {
      sendMessage("commands", "ON");
    }

    function turnOff() {
      sendMessage("commands", "OFF");
    }

    function setSchedule(e) {
      e.preventDefault();
      const jam = document.getElementById("jam").value.padStart(2, "0");
      const menit = document.getElementById("menit").value.padStart(2, "0");
      const action = document.getElementById("action").value;
      const msg = `${jam}:${menit}=${action}`;
      sendMessage("schedule", msg);
      alert("⏱ Jadwal dikirim: " + msg);
    }

    function clearSchedule() {
      if (!selectedDevice) return;
      if (confirm("Yakin ingin menghapus jadwal?")) {
        sendMessage("schedule", "clear_schedule");
      }
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    function updateLampIcon(status) {
      const icon = document.getElementById("lamp-icon");
      icon.innerHTML = status === "ON"
        ? `<svg ...>...</svg>`
        : `<svg ...>...</svg>`;
    }

    function updateClock() {
      const now = new Date();
      const jam = String(now.getHours()).padStart(2, '0');
      const menit = String(now.getMinutes()).padStart(2, '0');
      const detik = String(now.getSeconds()).padStart(2, '0');
      document.getElementById("clock").innerText = `${jam}:${menit}:${detik}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
