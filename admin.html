<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - YDC Smartlamp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f8ff;
      padding: 2rem;
    }
    h1 {
      color: #0077cc;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #e6f0ff;
    }
    select, input {
      padding: 0.4rem;
      font-size: 1rem;
    }
    button {
      padding: 0.4rem 0.8rem;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #005fa3;
    }
    .device-row {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>Admin Panel - YDC Smartlamp</h1>
  <div id="table-container">Memuat data pengguna...</div>

  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) return location.href = 'login.html';
      const adminRef = firebase.database().ref('users/' + user.uid);
      adminRef.once('value').then(snapshot => {
        if (snapshot.val()?.role !== 'admin') {
          document.body.innerHTML = '<h2>Akses ditolak: Anda bukan admin.</h2>';
          return;
        }
        loadUsers();
      });
    });

    function loadUsers() {
      const usersRef = firebase.database().ref('users');
      const devicesRef = firebase.database().ref('devices');

      usersRef.once('value').then(userSnap => {
        devicesRef.once('value').then(deviceSnap => {
          const users = userSnap.val() || {};
          const devices = deviceSnap.val() || {};
          let html = '<table><tr><th>Email</th><th>UID</th><th>Role</th><th>Account Type</th><th>Perangkat</th></tr>';

          Object.keys(users).forEach(uid => {
            const u = users[uid];
            html += `<tr>
              <td>${u.email}</td>
              <td>${uid}</td>
              <td>
                <select onchange="updateRole('${uid}', this.value)">
                  <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
                  <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
                </select>
              </td>
              <td>
                <select onchange="updateType('${uid}', this.value)">
                  <option value="basic" ${u.accountType === 'basic' ? 'selected' : ''}>basic</option>
                  <option value="standard" ${u.accountType === 'standard' ? 'selected' : ''}>standard</option>
                  <option value="premium" ${u.accountType === 'premium' ? 'selected' : ''}>premium</option>
                </select>
              </td>
              <td>`;
            if (devices[uid]) {
              html += '<table style="width:100%">';
              Object.entries(devices[uid]).forEach(([deviceID, dev]) => {
                html += `<tr class="device-row">
                  <td colspan="2">
                    <b>${deviceID}</b>: <input value="${dev.name}" onchange="updateDevice('${uid}','${deviceID}', this.value)"> 
                    <button onclick="deleteDevice('${uid}','${deviceID}')">üóëÔ∏è</button>
                  </td></tr>`;
              });
              html += '</table>';
            } else {
              html += 'Tidak ada perangkat';
            }
            html += '</td></tr>';
          });

          html += '</table>';
          document.getElementById('table-container').innerHTML = html;
        });
      });
    }

    function updateType(uid, type) {
      firebase.database().ref('users/' + uid + '/accountType').set(type)
        .then(() => alert('‚úÖ Account type diperbarui'))
        .catch(err => alert('‚ùå Gagal: ' + err.message));
    }

    function updateRole(uid, role) {
      firebase.database().ref('users/' + uid + '/role').set(role)
        .then(() => alert('‚úÖ Role diperbarui'))
        .catch(err => alert('‚ùå Gagal: ' + err.message));
    }

    function updateDevice(uid, deviceID, newName) {
      firebase.database().ref(`devices/${uid}/${deviceID}/name`).set(newName)
        .then(() => console.log('Perangkat diperbarui'))
        .catch(err => alert('‚ùå Gagal memperbarui perangkat: ' + err.message));
    }

    function deleteDevice(uid, deviceID) {
      if (confirm('Yakin ingin menghapus perangkat ini?')) {
        firebase.database().ref(`devices/${uid}/${deviceID}`).remove()
          .then(() => {
            alert('‚úÖ Perangkat dihapus.');
            location.reload();
          })
          .catch(err => alert('‚ùå Gagal menghapus: ' + err.message));
      }
    }
  </script>
</body>
</html>
